'use strict'

const fs = require('fs-extra')
const path = require('path')
const pify = require('pify')
const readdir = pify(fs.readdir)
const writeFile = pify(fs.writeFile)
const naturalSort = require('javascript-natural-sort')

const SUIR_DOCS_HTTP_ROOT = 'http://react.semantic-ui.com/'

// return suir.getComponents(this.suirSrcRoot)
//   .then(suir.filter)
//   .then(suir.mapToURIs)
//   .then(suir.mapToIFrames)
//   .then(suir.mapToStories)
//   .then(suir.concatImportsAndStories)
//   .then(txt => suir.writeStories(this.suirStoriesDest))

const suir = {
  _componentGroups: {
    /* elements: { TextArea, Input }, modules: { ... }, etc */
  },
  appendIFrames (components) {
    // 100% height renders a silly scroll bar
    return components.map(comp => {
      comp.iframe = `<iframe src="${comp.uri}" height='99%' width='100%' />`
      return comp
    })
  },
  appendURIs (components) {
    // e.g. http://react.semantic-ui.com/elements/button
    return components.map(comp => {
      comp.uri = `${SUIR_DOCS_HTTP_ROOT}/${this.mapToSUIRNamespace(comp.name)}/${comp.name}`
      return comp
    })
  },
  appendStories (components) {
    return components.map(comp => {
      comp.story = `.add('${comp.name}', () => ${comp.iframe})`
      return comp
    })
  },
  concatImportsAndStories (components) {
    var storyContent = components.map(comp => comp.story).join('\n')
    return [
      '// THIS FILE IS AUTO GENERATED BY THE BUILD. DO NOT MODIFY',
      `import React from 'react'`,
      `import { storiesOf } from '@kadira/storybook'`,
      `storiesOf('semantic-ui-react native', module)`,
      storyContent
    ].join('\n')
  },
  /**
   * Return set of component names, as named in their src/component/suir/<name>/
   * structure.
   * @param {string} storyRoot
   * @returns {Promise<Object>}
   */
  getComponents (storyRoot) {
    return readdir(storyRoot)
    .then(files => files.filter(basename => !basename.match(/\./)))
    .then(files => files.sort(naturalSort))
    .then(files => files.map(file => ({ name: file })))
  },
  init (builder) {
    return this.loadSUIRComponentGroups(builder)
  },
  /**
   * Reads the RU
   *
   * @param {any} builder
   * @returns
   */
  loadSUIRComponentGroups (builder) {
    const suirSrcRoot = path.resolve(builder.projectRoot, 'node_modules', 'semantic-ui-react', 'src')
    return readdir(suirSrcRoot)
    .then(files => files.filter(file => !file.match(/\./) && file !== 'lib'))
    .then(componentTypes => {
      return Promise.all([
        componentTypes,
        Promise.all(componentTypes.map(type => readdir(path.resolve(suirSrcRoot, type))))
      ])
    })
    .then(([types, componentSets]) => componentSets.forEach((set, ndx) => { this._componentGroups[types[ndx]] = set }))
  },
  mapToSUIRNamespace (componentName) {
    for (var type in this._componentGroups) {
      var group = this._componentGroups[type]
      var rx = new RegExp(`^${componentName}$`, 'i')
      if (group.some(name => name.match(rx))) return type
    }
    throw new Error([
      `Oh WAT! what is this component: "${componentName}"?`,
      'Are you sure it has a corresponding named component in `node_modules/semantic-ui-react/src/<group>/`?',
      'We currently see the following components in the SUI source:\n',
      JSON.stringify(this._componentGroups, null, 2)
    ].join(' '))
  },
  writeStories (txt, dest) {
    return writeFile(dest, txt)
  }
}

for (var key in suir) if (typeof suir[key] === 'function') suir[key] = suir[key].bind(suir)

module.exports = suir
